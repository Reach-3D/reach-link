name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Publish Python Agent Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Python Agent
        run: |
          mkdir -p dist
          cp src/reach-link-agent.py dist/reach-link.py
          chmod +x dist/reach-link.py
          sha256sum dist/reach-link.py | awk '{print $1}' > dist/reach-link.py.sha256
          echo "SHA256=$(cat dist/reach-link.py.sha256)" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/reach-link.py
            dist/reach-link.py.sha256
          body: |
            ## reach-link ${{ github.ref_name }}

            ### Universal Python Agent

            A single Python script for all platforms: ARM64, x86_64, MIPS, and others.

            **SHA-256:** `${{ env.SHA256 }}`

            ### Downloads

            ```bash
            # Download the universal Python agent
            wget https://github.com/Reach-3D/reach-link/releases/download/${{ github.ref_name }}/reach-link.py
            
            # Verify checksum
            echo "${{ env.SHA256 }}  reach-link.py" | sha256sum -c
            
            # Make executable
            chmod +x reach-link.py
            ```

            ### Requirements

            - Python 3.7+
            - Moonraker API available on the printer

            ### Installation

            #### Via Reach3DCommercial Installer (Recommended)
            The installer automatically detects your printer and deploys reach-link.py.

            #### Manual Installation

            ```bash
            # SSH into your printer
            ssh root@<printer-ip>
            
            # Create directory and download
            mkdir -p /root/reach-link
            cd /root/reach-link
            wget https://github.com/Reach-3D/reach-link/releases/download/${{ github.ref_name }}/reach-link.py
            chmod +x reach-link.py
            
            # Create .env file
            cat > .env << 'EOF'
            REACH_LINK_RELAY=https://relay.reach-3d.com
            REACH_LINK_TOKEN=your-secret-token
            REACH_LINK_PRINTER_ID=printer-id
            REACH_LINK_MOONRAKER_URL=http://127.0.0.1:7125
            EOF
            
            # Set up as a systemd service or supervisor job
            # See README for examples
            ```

            ### Configuration

            All configuration via environment variables:

            | Variable | Required | Default | Description |
            |----------|----------|---------|-------------|
            | `REACH_LINK_RELAY` | âœ… | - | HTTPS URL of Reach relay server |
            | `REACH_LINK_TOKEN` | âœ… | - | Bearer token for authentication |
            | `REACH_LINK_PRINTER_ID` | âœ… | - | Unique printer identifier |
            | `REACH_LINK_MOONRAKER_URL` | âŒ | `http://127.0.0.1:7125` | Moonraker API endpoint |
            | `REACH_LINK_HEARTBEAT_INTERVAL` | âŒ | `30` | Heartbeat interval (seconds) |
            | `REACH_LINK_TELEMETRY_INTERVAL` | âŒ | `10` | Telemetry interval (seconds) |
            | `REACH_LINK_LOG_FILE` | âŒ | - | Optional log file path |

            ### Features

            - ðŸŒ **Universal**: Works on ARM64, x86_64, MIPS, and any Linux with Python 3.7+
            - ðŸ“¤ **Telemetry**: Sends temperatures, job progress, system health to Reach relay
            - ðŸ’“ **Heartbeat**: Registers every 30s to keep printer online
            - ðŸ” **Secure**: HTTPS with bearer token authentication
            - ðŸ”„ **Resilient**: Automatic retry with exponential backoff
            - ðŸ“ **Logging**: Detailed stdout + optional file logging
            - ðŸš« **No Dependencies**: Minimal requirements (requests + tenacity optional, fallback to stdlib)

            ### Troubleshooting

            **"ModuleNotFoundError: No module named 'requests'"**
            - Install: `pip3 install requests==2.31.0`
            - Or script will fall back to stdlib urllib

            **"Connection refused" to Moonraker**
            - Verify Moonraker is running on port 7125 (or check `REACH_LINK_MOONRAKER_URL`)

            **Python 3 not found**
            - Install: `apt-get install python3` (Debian/Ubuntu) or equivalent

            ### Documentation

            - [GitHub Repository](https://github.com/Reach-3D/reach-link)
            - [Reach3D Documentation](https://reach3d.com/docs)
            - [Moonraker Project](https://moonraker.readthedocs.io/)
